<!DOCTYPE html>
<head Access-Control-Allow-Origin: *>
    <meta charset="UTF-8" />
    <title>2.02.01</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
</head>
<div id = "app"></div>
<div id = "text">Now Loading...</div>
<script src="https://pixijs.download/release/pixi.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/13.0.3/math.js" integrity="sha512-lAVGwhTndbBUjJlN0Lq4BNuOP0lpuGA9OUCA9bxRZrsehpmkiv8BcYdp91ON3XqJHWmVURGTw1d1W3LCr1k/1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/noisejs@2.1.0/index.min.js"></script>
<script type = "module" crossorigin="anonymous">
    addEventListener("fetch",(event)=>{
        event.respondWith(
            fetch(request)
                .then((response) => {
                    if (response.status === 0) {
                        return response;
                    }

                    const newHeaders = new Headers(response.headers);
                    newHeaders.set("Cross-Origin-Embedder-Policy",
                        coepCredentialless ? "credentialless" : "require-corp"
                    );
                    newHeaders.set("Cross-Origin-Opener-Policy", "same-origin");

                    return new Response(response.body, {
                        status: response.status,
                        statusText: response.statusText,
                        headers: newHeaders,
                    });
                })
                .catch((e) => console.error(e))
        );
    });
    
    const data_url = "https://script.google.com/macros/s/AKfycby58JoUBJtxn2AY0wecsxiryWR0gwkhLWzD7dVbCLnMbApqohJpWU5cZrEr0bUBo5lu/exec";
    let isHovered = false;
    let isClicked = false;
    let isSparked = false;
    const text_area = document.getElementById("text");
    let fire_graphics = [];
    let fire_positions = [];
    let particles = [];
    let clicked_num = 0;
    await PIXI.Assets.load('src/fling_L.png');
    await PIXI.Assets.load('src/fling_R.png');
    

    const noise = new Noise(1);
    let app_width = 0;
    let app_height = 0;

    let Sparking_time = 0;
    const fade_time = 2;
    const fire_dencity = 0.024;
    const fire_offset = 0;
    let fire_scale = 0;
    let target_fire_scale = 0;
    const click_area = new PIXI.Graphics();
    let spark_origin = [];
    let flingSprite_L = PIXI.Sprite.from('src/fling_L.png');
    let flingSprite_R = PIXI.Sprite.from('src/fling_R.png');

    const fire_filter = new PIXI.BlurFilter();
    fire_filter.blur = 5;

    const app = new PIXI.Application();
    await app.init({width: 600,height: 600,backgroundColor:0});
    document.getElementById('app').appendChild(app.canvas);
    app.stage.sortableChildren = true;
    const flings = new PIXI.Container();
    const fires = new PIXI.Container();
    const addfires = new PIXI.Container();
    const particles1 = new PIXI.Container();
    const particles2 = new PIXI.Container();
    flings.scale = 2;
    flings.zIndex = 1000;
    fires.zIndex = 1;
    addfires.zIndex = -1;
    fires.sortableChildren = true;
    app.stage.addChild(addfires);
    app.stage.addChild(flings);
    app.stage.addChild(fires);
    app.stage.addChild(particles1);
    app.stage.addChild(particles2);
    


    
    if (document.readyState ==="complete"){
        initiation();
    }else{
        window.addEventListener("load",initiation);
    }
    window.addEventListener("resize",initiation);
    
    

    function initiation(){
        screenResize();
        app_height = app.screen.height;
        app_width = app.screen.width;
        flings.position.set(app_width/2,app_height/2);
        particles2.y = app_height;
        fetchData(data_url,{method: "GET"},);
        setFire();
        set_particle();
        flings_depict();
        spark_origin = [-48,-280];
    }

    function flings_depict(){
        flingSprite_L.anchor.set(0.9,1);
        flingSprite_R.anchor.set(0.1,1);
        flingSprite_L.scale = 0.5;
        flingSprite_R.scale = 0.5;
        flingSprite_R.zIndex = 100;
        flingSprite_L.zIndex = 100;
        flings.addChild(flingSprite_L);
        flings.addChild(flingSprite_R);
    }
    
    function setFire(){
        fire_graphics.forEach(function(fire_seg){fire_seg.destroy();});
        fire_graphics = [];
        fire_positions = [];
        for(let i = 0; i < Math.round(app_width*fire_dencity); i++){
            const fire_seg = new PIXI.Graphics();
            fire_seg.filters = [fire_filter];
            fire_seg.zIndex = 10;
            fire_graphics.push(fire_seg);
            const fire_x = app_width*i/Math.round(app_width*fire_dencity)+noise.perlin2(50*i,1);
            const fire_y = rnorm(250,5000);
            fire_positions.push([[fire_x,app_height+fire_offset],[[240*(Math.round(Math.random())-0.5),0.3+0.5*fire_y*Math.random()],[0,fire_y]],0.5*(Math.random()-0.5)]);
        }
    }

    

    

    function fire_depict(fire_gfs,fire_pos,scale,t){
        fire_gfs.forEach(function(fire_seg,i){
            fire_seg.clear();
            const fire_color = chroma.temperature(5*fire_pos[i][1][1][1]+scale+300);
            fire_seg.poly(calc_fire_pos(fire_pos[i],(fire_pos[i][2]+0.05*noise.perlin2(i,5-t/50))/scale,scale,t,i)).fill(math.divide(fire_color.rgb(),255).concat((1-fire_color.get("hsl.l"))**1.5));
            fires.addChild(fire_seg);
        });   
    }

    function add_fire_depict(fire_gfs,fire_pos,scale,t){
        fire_gfs.forEach(function(fire_seg,i){
            fire_seg.clear();
            const fire_color = chroma.temperature(5*fire_pos[i][1][1][1]+scale+300);
            fire_seg.poly(calc_fire_pos(fire_pos[i],(fire_pos[i][2]+0.05*noise.perlin2(i,5-t/50))/scale,scale,t,i)).fill(math.divide(fire_color.rgb(),255).concat((1-fire_color.get("hsl.l"))**1.5));
            addfires.addChild(fire_seg);
        });   
    }

    function calc_fire_pos(pos,theta,scale,t,i){
        const v_o = pos[0];
        let M_raw = [[pos[1][0][0]*scale**0.4,pos[1][0][1]*scale**0.5],[pos[1][1][0],pos[1][1][1]*scale]];
        //M_raw[0][0] += 5*noise.perlin3(1*pos[1][0][0],scale*pos[1][0][1],t/1000);
        const M_noise = [[10*noise.perlin2(i,t/50),10*noise.perlin2(i,5+t/50)],[10*noise.perlin2(i,10+t/50),20*noise.perlin2(i,20+t/50)*scale*Math.cos(i+t/10)]];
        const M = math.transpose(math.add(M_raw,M_noise));
        const M_r = [[Math.cos(theta),-1*Math.sin(theta)],[Math.sin(theta),Math.cos(theta)]];
        const v_out = math.subtract(v_o,math.transpose(math.multiply(M_r,M)));
        return(v_o.concat(v_out.flat(Infinity)));
    }
   
    click_area.rect(-150,-170,260,190).fill({r:0,g:0,b:0,a:0});
    

    click_area.on('pointerdown',(event)=>{isHovered = true;});
    click_area.on('pointerup',(event)=>{isClicked = true;});
    click_area.on('pointerupoutside',(event)=>{isClicked = true;});
    click_area.eventMode = 'static';
    click_area.cursor = 'pointer';
    flings.addChild(click_area);

    
    const sparkRvs = [[74.026,134.426],[70.114,131.111],[169.223,50.535],[145.148,22.203]];    
    const sparkMvs = [[62.792,131.613],[58.278,131.513],[66.904,0],[49.952,4.822]];    
    const sparkLvs = [[44.936,128.398],[43.833,130.910],[7.820,83.118],[0.598,100.870]];    
    


    function calc_kt(vs){
        return(math.multiply(math.inv(math.transpose([math.subtract(vs[2],vs[0]),math.subtract(vs[3],vs[1])])),math.subtract(vs[1],vs[0])));
    }

    function calc_origin(vs){
        return(math.add(vs[0],math.multiply(calc_kt(vs)[0],math.subtract(vs[2],vs[0]))));
    }

    function localvec(vs,i){
        return(math.subtract(vs[i],calc_origin(vs)));
    }

    function calc_place(vs,t,type){
        return(math.add(math.multiply(localvec(vs,type),t),calc_origin(vs)));
    }

    function calc_places(vs,t){
        return([calc_place(vs,t,0)[0],calc_place(vs,t,0)[1],calc_place(vs,t,2)[0],calc_place(vs,t,2)[1],calc_place(vs,t,3)[0],calc_place(vs,t,3)[1],calc_place(vs,t,1)[0],calc_place(vs,t,1)[1]]);
    }

    const spark_offset = Math.max(math.norm(localvec(sparkRvs,0)),math.norm(localvec(sparkRvs,1)),math.norm(localvec(sparkRvs,2)),math.norm(localvec(sparkRvs,3)),math.norm(localvec(sparkMvs,0)),math.norm(localvec(sparkMvs,1)),math.norm(localvec(sparkMvs,2)),math.norm(localvec(sparkMvs,3)),math.norm(localvec(sparkLvs,0)),math.norm(localvec(sparkLvs,1)),math.norm(localvec(sparkLvs,2)),math.norm(localvec(sparkLvs,3)))

    const spark_R = new PIXI.Graphics();

    const spark_M = new PIXI.Graphics();

    const spark_L = new PIXI.Graphics();

    function fading(t,T){
        return((t**2)*Math.exp(1-t**2));
    }

    function spark_depict(t){
        spark_R.clear()
        spark_R.poly(calc_places(sparkRvs,t));
        spark_R.position.set(spark_origin[0],spark_origin[1]);
        spark_R.fill({r:255,g:0,b:34,a:fading(t,fade_time)});
        flings.addChild(spark_R);
        spark_M.clear()
        spark_M.poly(calc_places(sparkMvs,t));
        spark_M.position.set(spark_origin[0],spark_origin[1]);
        spark_M.fill({r:0,g:168,b:219,a:fading(t,fade_time)});
        flings.addChild(spark_M);
        spark_L.clear()
        spark_L.poly(calc_places(sparkLvs,t));
        spark_L.position.set(spark_origin[0],spark_origin[1]);
        spark_L.fill({r:0,g:168,b:219,a:fading(t,fade_time)});
        flings.addChild(spark_L);
    }

    


    let fire_time = 0;
    let adding_time = 30;
    let add_fire = false;
    let add_fire_time = 0;
    let interval_time = 0;
    let down_fire = false;
    let click_num_temp = 0;
    let fire_add_gfs = [];
    let fire_add_pos = [];
    let fire_add_h = [];
    app.ticker.add((time)=>
    {
        if (isHovered & !isClicked & flingSprite_R.rotation < 3.14/6){
            flingSprite_L.rotation -= 0.2 * time.deltaTime;
            flingSprite_R.rotation += 0.2 * time.deltaTime;
        }
        if (isClicked){
            flingSprite_L.rotation += 0.5 * time.deltaTime;
            flingSprite_R.rotation -= 0.5 * time.deltaTime;
            
            if(flingSprite_R.rotation <= 0){
                flingSprite_L.rotation =0;
                flingSprite_R.rotation =0;
                isClicked = false;
                isHovered = false;
                isSparked = true;
            }
        }
        if(isSparked){
            spark_depict(Sparking_time);
            Sparking_time += time.deltaTime*0.3;
            if(Sparking_time >= fade_time){
                spark_depict(0);
                Sparking_time = 0;
                isSparked = false;
                add_fire = true;
                click_num_temp += 1;
                clicked_num += 1;
                text_area.innerText = clicked_num;
                target_fire_scale = 1.5*Math.log10(clicked_num+1); 
            }
        }
        if(add_fire){
            if(add_fire_time == 0){
                for(let i =0;i < 0.3*Math.round(app_width*fire_dencity);i++){
                    const add_gf = new PIXI.Graphics();
                    add_gf.zIndex = -1;
                    add_gf.filters = [fire_filter];
                    fire_add_gfs.push(add_gf);
                    const fire_x = app_width*i/Math.round(0.3*app_width*fire_dencity)+noise.perlin2(50*i,1);
                    const fire_y = rnorm(300,5000);
                    fire_add_pos.push([[fire_x,app_height+fire_offset],[[240*(Math.round(Math.random())-0.5),0.3+0.5*fire_y*Math.random()],[0,fire_y]],0.5*(Math.random()-0.5)]);
                    fire_add_h.push(fire_y);
                }
            }
            add_fire_time += time.deltaTime;
            fire_add_pos.forEach(function(po,i){
                po[1][1][1] = 4*fire_add_h[i]*add_fire_time*(1-add_fire_time/adding_time)/adding_time;
                //console.log(po[1][1][1])
            });
            if(add_fire_time > adding_time){
                down_fire = true;  
            }
        }
        if(down_fire){
            fire_add_gfs.forEach(function(add_gf,i){
                add_gf.destroy();  
            });
            fire_add_gfs.splice(0);
            fire_add_pos.splice(0);
            add_fire = false;
            add_fire_time = 0;
            down_fire = false;
        }
        
        particles1.y -= time.deltaTime;
        particles2.y -= time.deltaTime;

        if(particles1.y <= -app_height){
            particles1.y = app_height;
        }
        if(particles2.y <= -app_height){
            particles2.y = app_height;
        }

        add_fire_depict(fire_add_gfs,fire_add_pos,fire_scale,fire_time);
        fire_depict(fire_graphics,fire_positions,fire_scale,fire_time);
        
        fire_time += time.deltaTime;
        interval_time += time.deltaTime;
        if(interval_time >= 60){
            //console.log(60/time.deltaTime);
            interval_time = 0;
            fetchData(data_url,{method:"POST",body: JSON.stringify({value:click_num_temp})});
            fetchData(data_url,{method: "GET",},);
            text_area.innerText = clicked_num;
            target_fire_scale = 1.5*Math.log10(clicked_num+1); 
        }
        fire_scale += time.deltaTime*(target_fire_scale-fire_scale)/50;
    });
    
    function screenResize(){
        let width = window.innerWidth;
        let height = window.innerHeight;
        app.renderer.resize(width,height);
    }

    function rnorm(m,s){
        let a = 1-Math.random();
        let b = 1-Math.random();
        let c = Math.sqrt(-2*Math.log(a));
        if(0.5-Math.random()>0){
            return(c*Math.sin(Math.PI*2*b)*Math.sqrt(s)+m);
        }else{
            return(c*Math.cos(Math.PI*2*b)*Math.sqrt(s)+m);
        }
    }

    function set_particle(){
        for(let i=0;i<Math.round(app_height*app_width/50000);i++){
        const circle1 = new PIXI.Graphics;
        const color = chroma.temperature(1000+2000*Math.random());
        circle1.circle(Math.random()*app_width,Math.random()*app_height,0.003*app_width*(1*Math.random()+2)).fill(math.divide(color.rgb(),255).concat(1));
        //circle1.filters = [fire_filter];
        particles1.addChild(circle1);
        }
        for(let i=0;i<Math.round(app_height*app_width/50000);i++){
        const circle2 = new PIXI.Graphics;
        const color = chroma.temperature(1000+2000*Math.random());
        circle2.circle(Math.random()*app_width,Math.random()*app_height,0.003*app_width*(1*Math.random()+2)).fill(math.divide(color.rgb(),255).concat(1));
        //circle2.filters = [fire_filter];
        particles2.addChild(circle2);
        }
    }

    async function fetchData(url, options) {
        if(options["method"] == "POST"){
            click_num_temp = 0;
        }
        try {
            const response = await fetch(url, options);
            const data = await response.json();
            //console.log(data);
            clicked_num = Math.max(clicked_num,data.value);
        } catch (error) {
        //console.error("Error:", error);
    }
}
</script>
<style>
    body{
        margin: 0px;
        overflow:hidden;
        user-select: none;
        -webkit-user-select:none;
        position: absolute;
        }
    #text{
        color: #ffffff;
        font-size: 640%;
        text-align: center;
        position: absolute;
        height: 10%;
        width:100%;
        bottom: 39%;

        font-family: "Oswald", sans-serif;
        font-optical-sizing: auto;
        font-weight: 500;
        font-style: normal;
        letter-spacing: 0.07em;
        }
</style>