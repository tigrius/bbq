<!DOCTYPE html>
<meta charset="UTF-8" />
<div id = "app"></div>
<script src="https://pixijs.download/release/pixi.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/13.0.3/math.js" integrity="sha512-lAVGwhTndbBUjJlN0Lq4BNuOP0lpuGA9OUCA9bxRZrsehpmkiv8BcYdp91ON3XqJHWmVURGTw1d1W3LCr1k/1g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type = "module">
    const app = new PIXI.Application();
    await app.init({width: 600,height: 600,backgroundColor:0});
    document.getElementById('app').appendChild(app.canvas);
    function screenResize(){
        let width = window.innerWidth;
        let height = window.innerHeight;
        app.renderer.resize(width,height)
    }

    window.addEventListener("load",screenResize);
    window.addEventListener("resize",screenResize);

    let isHovered = false;
    let isClicked = false;
    let isSparked = false;
    let Sparking_time = 0;
    const fade_time = 2;

    await PIXI.Assets.load('src/fling_L.png')
    let flingSprite_L = PIXI.Sprite.from('src/fling_L.png');
    flingSprite_L.anchor.set(0.9,1);
    flingSprite_L.x = app.screen.width / 2;
    flingSprite_L.y = app.screen.height / 2;
    flingSprite_L.scale = 0.5
    app.stage.addChild(flingSprite_L);

    await PIXI.Assets.load('src/fling_R.png')
    let flingSprite_R = PIXI.Sprite.from('src/fling_R.png');
    flingSprite_R.anchor.set(0.1,1);
    flingSprite_R.x = app.screen.width / 2;
    flingSprite_R.y = app.screen.height / 2;
    flingSprite_R.scale = 0.5
    app.stage.addChild(flingSprite_R);

    const fire_seg = new PIXI.Graphics();
    const firePath = [0,0,100,0,0,100]
    fire_seg.poly(firePath);
    fire_seg.fill(0xff0000,0)
    app.stage.addChild(fire_seg);

    const click_area = new PIXI.Graphics();
   
    click_area.rect(-150,-170,260,190).fill(0xffffff,0);
    click_area.x = app.screen.width / 2;
    click_area.y = app.screen.height / 2;

    click_area.on('pointerdown',(event)=>{isHovered = true;});
    click_area.on('pointerenter',(event)=>{isHovered = true;});
    click_area.on('pointerup',(event)=>{isClicked = true;});
    click_area.on('pointerleave',(event)=>{isClicked = true;});
    click_area.eventMode = 'static';
    click_area.cursor = 'pointer';
    app.stage.addChild(click_area);

    const spark_origin = [app.screen.width / 2  -48,app.screen.height / 2 -280];
    const sparkRvs = [[74.026,134.426],[70.114,131.111],[169.223,50.535],[145.148,22.203]];    
    const sparkMvs = [[62.792,131.613],[58.278,131.513],[66.904,0],[49.952,4.822]];    
    const sparkLvs = [[44.936,128.398],[43.833,130.910],[7.820,83.118],[0.598,100.870]];    
    


    function calc_kt(vs){
        return(math.multiply(math.inv(math.transpose([math.subtract(vs[2],vs[0]),math.subtract(vs[3],vs[1])])),math.subtract(vs[1],vs[0])));
    }

    function calc_origin(vs){
        return(math.add(vs[0],math.multiply(calc_kt(vs)[0],math.subtract(vs[2],vs[0]))))
    }

    function localvec(vs,i){
        return(math.subtract(vs[i],calc_origin(vs)));
    }

    function calc_place(vs,t,type){
        return(math.add(math.multiply(localvec(vs,type),t),calc_origin(vs)));
    }

    function calc_places(vs,t){
        return([calc_place(vs,t,0)[0],calc_place(vs,t,0)[1],calc_place(vs,t,2)[0],calc_place(vs,t,2)[1],calc_place(vs,t,3)[0],calc_place(vs,t,3)[1],calc_place(vs,t,1)[0],calc_place(vs,t,1)[1]]);
    }

    const spark_offset = Math.max(math.norm(localvec(sparkRvs,0)),math.norm(localvec(sparkRvs,1)),math.norm(localvec(sparkRvs,2)),math.norm(localvec(sparkRvs,3)),math.norm(localvec(sparkMvs,0)),math.norm(localvec(sparkMvs,1)),math.norm(localvec(sparkMvs,2)),math.norm(localvec(sparkMvs,3)),math.norm(localvec(sparkLvs,0)),math.norm(localvec(sparkLvs,1)),math.norm(localvec(sparkLvs,2)),math.norm(localvec(sparkLvs,3)))

    const spark_R = new PIXI.Graphics();

    const spark_M = new PIXI.Graphics();

    const spark_L = new PIXI.Graphics();

    function fading(t,T){
        return((t**2)*Math.exp(1-t**2));
    }

    function depict(t){
        spark_R.clear()
        spark_R.poly(calc_places(sparkRvs,t));
        spark_R.position.set(spark_origin[0],spark_origin[1]);
        spark_R.fill(0xff0022,fading(t,fade_time));
        app.stage.addChild(spark_R);
        spark_M.clear()
        spark_M.poly(calc_places(sparkMvs,t));
        spark_M.position.set(spark_origin[0],spark_origin[1]);
        spark_M.fill(0x00A8db,fading(t,fade_time));
        app.stage.addChild(spark_M);
        spark_L.clear()
        spark_L.poly(calc_places(sparkLvs,t));
        spark_L.position.set(spark_origin[0],spark_origin[1]);
        spark_L.fill(0x00a8db,fading(t,fade_time));
        app.stage.addChild(spark_L);
    }

    app.ticker.add((time)=>
    {
        if (isHovered & !isClicked & flingSprite_R.rotation < 3.14/6){
            flingSprite_L.rotation -= 0.2 * time.deltaTime;
            flingSprite_R.rotation += 0.2 * time.deltaTime;
        }
        if (isClicked & isHovered){
            flingSprite_L.rotation += 0.5 * time.deltaTime;
            flingSprite_R.rotation -= 0.5 * time.deltaTime;
            if(flingSprite_R.rotation <= 0){
                flingSprite_L.rotation =0;
                flingSprite_R.rotation =0;
                isClicked = false;
                isHovered = false;
                isSparked = true;
            }
        }
        if(isSparked){
            depict(Sparking_time);
            Sparking_time += time.deltaTime*0.3;
            if(Sparking_time >= fade_time){
                depict(0);
                Sparking_time = 0;
                isSparked = false;
            }
        }
    }
)  
    

</script>
<style>
    body{
        margin: 0px;
        overflow:hidden;
        user-select: none;
        }
</style>